<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Popote & Compagnie</title>
  <style>
    body {margin:0;font-family:Arial,sans-serif;background:white;display:flex;flex-direction:column;min-height:100vh;}
    header{text-align:center;padding:40px 20px 20px;font-size:32px;font-weight:bold;}
    main{flex:1;display:none;flex-direction:column;align-items:center;justify-content:center;gap:15px;}
    footer{text-align:center;padding:10px 0;font-size:14px;color:#666;}
    button{padding:10px 20px;font-size:15px;border:none;border-radius:6px;cursor:pointer;background-color:#ff914d;color:white;}
    .link{font-size:16px;color:#333;text-decoration:underline;cursor:pointer;}
    .form input{padding:8px;font-size:14px;}
    table{border-collapse:collapse;width:80%;}
    th,td{border:1px solid #ccc;padding:8px;text-align:left;}
    .error{color:red;font-size:14px;}
    .nav{margin-bottom:10px;}
  </style>
</head>
<body>
  <header>Popote & Compagnie</header>

  <main id="landing" style="display:flex;">
    <button id="createAccountBtn">Créer mon compte</button>
    <div class="link" id="loginLink">Connexion</div>
  </main>

  <main id="signup" class="form">
    <div class="nav"><button class="backBtn">Retour</button></div>
    <input type="text" id="nom" placeholder="Nom" />
    <input type="text" id="prenom" placeholder="Prénom" />
    <input type="email" id="emailSignup" placeholder="Adresse mail" />
    <input type="password" id="passwordSignup" placeholder="Mot de passe" />
    <button id="togglePassword">Voir le mot de passe</button>
    <button id="submitSignup">Créer le compte</button>
    <div id="signupError" class="error"></div>
  </main>

  <main id="login" class="form">
    <div class="nav"><button class="backBtn">Retour</button></div>
    <input type="email" id="emailLogin" placeholder="Adresse mail" />
    <input type="password" id="passwordLogin" placeholder="Mot de passe" />
    <button id="submitLogin">Connexion</button>
    <div id="loginError" class="error"></div>
  </main>

  <main id="home">
    <div>Bienvenue à toi !</div>
    <button id="popotierBtn">Popotier</button>
    <div class="nav"><button class="backBtn">Retour</button></div>
  </main>

  <main id="popotier">
    <div class="nav"><button class="backBtn">Retour</button></div>
    <h2>Popotier</h2>
    <button id="membersBtn">Membres</button>
  </main>

  <main id="members">
    <div class="nav"><button class="backBtn">Retour</button></div>
    <h2>Membres</h2>
    <table id="membersTable">
      <thead><tr><th>Nom</th><th>Prénom</th><th>Email</th><th>Date création</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
    <button id="archivesBtn">Archives</button>
  </main>

  <main id="archives">
    <div class="nav"><button class="backBtn">Retour</button></div>
    <h2>Archives</h2>
    <table id="archivesTable">
      <thead><tr><th>Nom</th><th>Prénom</th><th>Email</th><th>Date création</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>La Popote 2.0 - BETA 0.1.1</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJFyX4n6s5ER6_LiS22JtJ01VBvR8YM0g", authDomain: "popotecompagnie-2e79f.firebaseapp.com", projectId: "popotecompagnie-2e79f", storageBucket: "popotecompagnie-2e79f.firebasestorage.app", messagingSenderId: "643014117897", appId: "1:643014117897:web:254fd7aad817ed902086d8" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "pierre.valentin8@gmail.com";

    const pages = ["landing","signup","login","home","popotier","members","archives"];
    let historyStack = ["landing"];

    const show = id => {
      const current = historyStack[historyStack.length - 1];
      if (current !== id) historyStack.push(id);
      pages.forEach(p=>document.getElementById(p).style.display = p===id?"flex":"none");
    };

    const goBack = () => {
      if (historyStack.length > 1) {
        historyStack.pop();
        const prev = historyStack[historyStack.length - 1];
        pages.forEach(p=>document.getElementById(p).style.display = p===prev?"flex":"none");
      }
    };

    document.querySelectorAll('.backBtn').forEach(btn => btn.onclick = goBack);

    document.getElementById("createAccountBtn").onclick = ()=>show("signup");
    document.getElementById("loginLink").onclick = ()=>show("login");

    document.getElementById("togglePassword").onclick = ()=>{
      const pwd=document.getElementById("passwordSignup");
      pwd.type = pwd.type==='password' ? 'text' : 'password';
    };

    document.getElementById("submitSignup").onclick = async ()=>{
      const errorDiv = document.getElementById("signupError");
      errorDiv.textContent = "";
      const nom = document.getElementById("nom").value.trim();
      const prenom = document.getElementById("prenom").value.trim();
      const email = document.getElementById("emailSignup").value.trim();
      const password = document.getElementById("passwordSignup").value;
      if (!nom || !prenom || !email || !password) {
        errorDiv.textContent = "Tous les champs sont obligatoires.";
        return;
      }
      try {
        const res = await createUserWithEmailAndPassword(auth,email,password);
        // Store the Firestore document ID as well so we can reference it later
        await addDoc(collection(db,"users"),{
          uid: res.user.uid,
          nom,
          prenom,
          email,
          created: serverTimestamp()
        });
        show("login");
      } catch (err) {
        if (err.code === 'auth/email-already-in-use') {
          errorDiv.textContent = "Cette adresse mail est déjà utilisée. Veuillez vous connecter ou utiliser une autre adresse.";
        } else {
          errorDiv.textContent = err.message;
        }
      }
    };

    document.getElementById("submitLogin").onclick = async ()=>{
      const errorDiv = document.getElementById("loginError");
      errorDiv.textContent = "";
      const email = document.getElementById("emailLogin").value.trim();
      const password = document.getElementById("passwordLogin").value;
      try {
        await signInWithEmailAndPassword(auth,email,password);
        show("home");
        document.getElementById("popotierBtn").style.display = email===ADMIN_EMAIL?"block":"none";
      } catch (err) {
        errorDiv.textContent = "Identifiants incorrects.";
      }
    };

    document.getElementById("popotierBtn").onclick = ()=>show("popotier");
    document.getElementById("membersBtn").onclick = loadMembers;
    document.getElementById("archivesBtn").onclick = loadArchives;

    function safeDate(u){
      if (!u || !u.created) return "—";
      try {
        if (typeof u.created.toDate === 'function') return u.created.toDate().toLocaleDateString();
        if (u.created.seconds) return new Date(u.created.seconds*1000).toLocaleDateString();
        const d = new Date(u.created);
        return isNaN(d.getTime()) ? "—" : d.toLocaleDateString();
      } catch(e) {
        return "—";
      }
    }

    async function loadMembers(){
      show("members");
      const snap = await getDocs(collection(db,"users"));
      const tbody = document.querySelector("#membersTable tbody"); tbody.innerHTML="";
      snap.forEach(d=>{
        const u = d.data();
        // Assign the Firestore document ID so we can delete or reference it correctly
        u.docId = d.id;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${u.nom||""}</td><td>${u.prenom||""}</td><td>${u.email||""}</td><td>${safeDate(u)}</td><td><button>Archiver</button></td>`;
        tr.querySelector("button").onclick = async()=>{
          await addDoc(collection(db,"archives"), u);
          await deleteDoc(doc(db,"users", u.docId));
          loadMembers();
        };
        tbody.appendChild(tr);
      });
    }

    async function loadArchives(){
      show("archives");
      const snap = await getDocs(collection(db,"archives"));
      const tbody = document.querySelector("#archivesTable tbody"); tbody.innerHTML="";
      snap.forEach(d=>{
        const u = d.data();
        u.docId = d.id;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${u.nom||""}</td><td>${u.prenom||""}</td><td>${u.email||""}</td><td>${safeDate(u)}</td><td><button>Supprimer</button></td>`;
        tr.querySelector("button").onclick = async()=>{ await deleteDoc(doc(db,"archives", u.docId)); loadArchives(); };
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
