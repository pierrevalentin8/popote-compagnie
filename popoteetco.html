<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

// --- Configuration Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyAJFyX4n6s5ER6_LiS22JtJ01VBvR8YM0g",
  authDomain: "popotecompagnie-2e79f.firebaseapp.com",
  projectId: "popotecompagnie-2e79f",
  storageBucket: "popotecompagnie-2e79f.firebasestorage.app",
  messagingSenderId: "643014117897",
  appId: "1:643014117897:web:254fd7aad817ed902086d8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;

// ---- UTILITAIRES ----
function hideAll(){
  ["home","register","login","main","popote","members"].forEach(id => document.getElementById(id).classList.add("hidden"));
}

function navigate(page){
  hideAll();
  document.getElementById(page).classList.remove("hidden");
  if(page === "main") showMain();
  if(page === "popote") showPopote();
}

// ---- USERS FIRESTORE ----
async function getUserData(uid){
  const docRef = doc(db, "users", uid);
  const docSnap = await getDoc(docRef);
  return docSnap.exists() ? docSnap.data() : null;
}

async function saveUserData(uid, data){
  await setDoc(doc(db, "users", uid), data);
}

async function updateUserData(uid, data){
  await updateDoc(doc(db, "users", uid), data);
}

async function getAllUsers(){
  const snapshot = await getDocs(collection(db, "users"));
  let users = {};
  snapshot.forEach(doc => users[doc.id] = doc.data());
  return users;
}

// ---- POPOTE FIRESTORE ----
async function getPopoteData(month){
  const docRef = doc(db, "popote", month.toString());
  const docSnap = await getDoc(docRef);
  return docSnap.exists() ? docSnap.data() : {};
}

async function savePopoteData(month, data){
  await setDoc(doc(db, "popote", month.toString()), data);
}

// ---- INSCRIPTION ----
async function register(){
  const nom = document.getElementById("nom").value.trim();
  const prenom = document.getElementById("prenom").value.trim();
  const pseudo = document.getElementById("pseudo").value.trim();
  const password = document.getElementById("password").value.trim();

  if(!nom || !prenom || !pseudo || !password){
    document.getElementById("registerMsg").innerText = "Tous les champs sont requis."; 
    return;
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, pseudo+"@popote.com", password);
    const uid = userCredential.user.uid;
    const role = pseudo === "PM" ? "Admin" : "Membre";

    await saveUserData(uid, {nom, prenom, character: pseudo, role, createdAt: new Date().toLocaleDateString()});

    document.getElementById("registerMsg").innerText = "Compte créé ! Connectez-vous.";
    navigate("login");
  } catch(error){
    document.getElementById("registerMsg").innerText = error.message;
  }
}

// ---- CONNEXION ----
async function login(){
  const pseudo = document.getElementById("loginPseudo").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  try {
    const userCredential = await signInWithEmailAndPassword(auth, pseudo+"@popote.com", password);
    currentUser = userCredential.user;
    navigate("main");
  } catch(error){
    document.getElementById("loginMsg").innerText = "Pseudo ou mot de passe incorrect.";
  }
}

// ---- DÉCONNEXION ----
async function logout(){
  await signOut(auth);
  currentUser = null;
  navigate("home");
}

// ---- PAGE PRINCIPALE ----
async function showMain(){
  if(!currentUser) return;
  const userData = await getUserData(currentUser.uid);
  document.getElementById("welcome").innerText = "Bienvenue " + userData.character + " (" + userData.role + ")";
}

// ---- POPOTE ----
async function showPopote(){
  const monthDiv = document.getElementById("monthButtons");
  monthDiv.innerHTML = "";
  for(let m=1; m<=12; m++){
    let btn = document.createElement("button");
    btn.innerText = monthName(m);
    btn.onclick = (()=>showMonth(m));
    monthDiv.appendChild(btn);
  }
}

function monthName(m){ 
  return ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"][m-1]; 
}

async function showMonth(month){
  const users = await getAllUsers();
  const tableDiv = document.getElementById("monthTable");
  tableDiv.innerHTML = "";

  let table = document.createElement("table");
  let header = table.insertRow();
  ["Nom","Prénom","Eau","Soda","Gourmandise","Totaux","Action"].forEach(h=>{
    let th = document.createElement("th"); th.innerText = h; header.appendChild(th);
  });

  const prices = {Eau:0.5, Soda:0.7, Gourmandise:0.5};
  let popoteData = await getPopoteData(month);

  for(let uid in users){
    if(users[uid].archived) continue;
    let row = table.insertRow();
    row.insertCell().innerText = users[uid].nom;
    row.insertCell().innerText = users[uid].prenom;

    ["Eau","Soda","Gourmandise"].forEach(p=>{
      let cell = row.insertCell();
      let inp = document.createElement("input"); 
      inp.type = "number"; inp.min=0;
      inp.value = (popoteData[uid] && popoteData[uid][p]) || 0;

      inp.oninput = async ()=>{
        if(!popoteData[uid]) popoteData[uid] = {};
        popoteData[uid][p] = parseFloat(inp.value) || 0;
        await savePopoteData(month, popoteData);
        updateTotals(table, prices);
        updateSummary();
      };

      cell.appendChild(inp);
    });

    let actionCell = row.insertCell();
    const currentData = await getUserData(currentUser.uid);
    if(currentData.role === "Admin" && users[uid].character !== "PM"){
      let deleteBtn = document.createElement("button");
      deleteBtn.innerText = "Supprimer";
      deleteBtn.onclick = async ()=>{
        if(confirm(`Voulez-vous vraiment supprimer ${users[uid].nom} ${users[uid].prenom} à partir de ce mois ?`)){
          for(let m = month; m <= 12; m++){
            let monthData = await getPopoteData(m);
            delete monthData[uid];
            await savePopoteData(m, monthData);
          }
          alert(`${users[uid].nom} ${users[uid].prenom} a été supprimé à partir de ${monthName(month)}.`);
          showMonth(month);
          updateSummary();
        }
      };
      actionCell.appendChild(deleteBtn);
    }
  }

  tableDiv.appendChild(table);
  updateTotals(table, prices);
  updateSummary();
}

function updateTotals(table, prices){
  for(let i=1; i<table.rows.length; i++){ 
    let row = table.rows[i];
    let total = 0;
    ["Eau","Soda","Gourmandise"].forEach((p,j)=>{
      let val = parseFloat(row.cells[j+2].firstChild.value) || 0;
      total += val * prices[p];
    });
    row.cells[5].innerText = total.toFixed(2) + " €";
  }
}

async function updateSummary() {
  const users = await getAllUsers();
  let summaryDiv = document.getElementById("popoteSummary");
  summaryDiv.innerHTML = "";

  let table = document.createElement("table");
  let header = table.insertRow();
  ["Nom","Prénom","Eau","Soda","Gourmandise","Total €"].forEach(h=>{
    let th = document.createElement("th");
    th.innerText = h;
    header.appendChild(th);
  });

  for(let uid in users){
    if(users[uid].archived) continue;
    let totalEau=0, totalSoda=0, totalGourmandise=0;

    for(let m=1; m<=12; m++){
      let monthData = await getPopoteData(m);
      if(monthData[uid]){
        totalEau += monthData[uid].Eau || 0;
        totalSoda += monthData[uid].Soda || 0;
        totalGourmandise += monthData[uid].Gourmandise || 0;
      }
    }

    let totalAmount = totalEau*0.5 + totalSoda*0.7 + totalGourmandise*0.5;
    let row = table.insertRow();
    row.insertCell().innerText = users[uid].nom;
    row.insertCell().innerText = users[uid].prenom;
    row.insertCell().innerText = totalEau;
    row.insertCell().innerText = totalSoda;
    row.insertCell().innerText = totalGourmandise;
    row.insertCell().innerText = totalAmount.toFixed(2) + " €";
  }

  summaryDiv.appendChild(table);
}

// ---- EFFECTIF ----
async function showMembers(){
  navigate('members');

  const users = await getAllUsers();
  const table = document.getElementById("membersTable");
  const info = document.getElementById("membersInfo");
  table.querySelectorAll("tr:not(:first-child)").forEach(r => r.remove());

  let activeCount=0, archivedCount=0;
  const currentData = await getUserData(currentUser.uid);

  for(let uid in users){
    if(users[uid].archived){
      archivedCount++;
      continue;
    }

    activeCount++;
    let row = table.insertRow();
    row.insertCell().innerText = users[uid].nom;
    row.insertCell().innerText = users[uid].prenom;
    row.insertCell().innerText = users[uid].createdAt || new Date().toLocaleDateString();

    let cell = row.insertCell();
    if(currentData.role === "Admin" && users[uid].character !== "PM"){
      let btn = document.createElement("button");
      btn.innerText = "Archiver";
      btn.onclick = ()=>archiveMember(uid);
      cell.appendChild(btn);
    }
  }

  info.innerText = `Membres actifs: ${activeCount} | Membres archivés: ${archivedCount}`;
  document.getElementById("showArchivedBtn").classList.toggle('hidden', currentData.role !== "Admin");
}

// ---- ARCHIVAGE ----
async function archiveMember(uid){
  let archiveDate = prompt("Entrez la date d'archivage (JJ/MM/AAAA) :", new Date().toLocaleDateString());
  if(!archiveDate) return;

  const users = await getAllUsers();
  users[uid].archived = true;
  users[uid].deletedAt = archiveDate;
  await updateUserData(uid, {archived:true, deletedAt:archiveDate});

  // Supprimer les données Popote suivantes
  let [day, month, year] = archiveDate.split("/").map(Number);
  for(let m=month+1; m<=12; m++){
    let monthData = await getPopoteData(m);
    if(monthData[uid]) delete monthData[uid];
    await savePopoteData(m, monthData);
  }

  alert(`${users[uid].nom} ${users[uid].prenom} a été archivé à partir de ${archiveDate}.`);
  showMembers();
}

// ---- Membres archivés ----
async function showArchived(){
  const users = await getAllUsers();
  const table = document.getElementById("archivedTable");
  table.querySelectorAll("tr:not(:first-child)").forEach(r => r.remove());

  const currentData = await getUserData(currentUser.uid);

  for(let uid in users){
    if(users[uid].archived){
      let row = table.insertRow();
      row.insertCell().innerText = users[uid].nom;
      row.insertCell().innerText = users[uid].prenom;
      row.insertCell().innerText = users[uid].deletedAt;

      if(currentData.role === "Admin"){
        let cell = row.insertCell();
        let removeBtn = document.createElement("button");
        removeBtn.innerText = "Supprimer définitivement";
        removeBtn.onclick = async ()=>{
          if(confirm(`Voulez-vous vraiment supprimer définitivement ${users[uid].nom} ${users[uid].prenom} ?`)){
            await deleteDoc(doc(db, "users", uid));
            for(let m=1; m<=12; m++){
              let monthData = await getPopoteData(m);
              if(monthData[uid]) delete monthData[uid];
              await savePopoteData(m, monthData);
            }
            showArchived();
            alert("Membre supprimé définitivement.");
          }
        };
        cell.appendChild(removeBtn);
      }
    }
  }

  document.getElementById("archivedMembers").classList.remove("hidden");
}

// ---- Placeholder Popote & Compagnie ----
function popoteCompagnie(){ alert("Popote & Compagnie (non implémenté)"); }

</script>
